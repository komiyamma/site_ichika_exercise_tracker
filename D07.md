

# 🌀 第7章：データ構造と `localStorage` の理解 🐾

## 🌟 7.1 思考の軌跡：データをどう保存するか

最初にやるべきことは、 **データをどう保存するか** です。`localStorage`は、ブラウザにデータを保存するための便利な方法で、データを **永続的に保存** することができます。今回は、運動記録を **`localStorage`に保存** して、ページがリロードされてもデータを消さないようにします。

---

## 🌼 7.2 `localStorage`の基本を理解する

まずは、 **`localStorage`の基本的な使い方** を学びます。`localStorage`は、ブラウザに **キーと値のペア** としてデータを保存します。保存したデータはページをリロードしても残り、次回アクセスしたときにも利用できます。

### **基本的な使い方**

```javascript
// データを保存する
localStorage.setItem('key', 'value');

// データを取得する
const value = localStorage.getItem('key');

// データを削除する
localStorage.removeItem('key');
```

### **思考の軌跡** ：

「`localStorage`にデータを保存するには、 **文字列に変換して保存** する必要がある。だから、 **オブジェクトを文字列に変換** し、後で取り出すときは **文字列をオブジェクトに戻す** 必要がある。」

---

## 🌸 7.3 データ構造を設計する

運動記録を保存するための **データ構造** を考えます。運動記録には、運動種目、日付、時間、回数、メモなどが含まれるので、これらの情報をひとまとめにして保存する必要があります。

### **思考の軌跡** ：

「運動記録を保存するためには、少なくとも **運動種目、日付、時間、回数、メモ** が必要だ。これらの情報をひとつのオブジェクトにまとめて、`localStorage`に保存しよう。」

#### **データ構造の例** ：

```javascript
{
    id: 'unique-id', // 一意なID（削除や編集時に使用）
    date: '2023-04-01',
    type: 'ランニング',
    minutes: 30,
    value: 5,
    note: '今日は調子が良かった',
    createdAt: 1678535800000 // 作成日時（ミリ秒）
}
```

### **思考の軌跡** ：

「この構造を使ってデータを保存し、後で取得して表示できるようにしよう。」

---

## 🌼 7.4 フォームからデータを取得する準備

次に進む前に、フォームからデータをどう取得するかを確認します。 **フォームに入力されたデータ** は、ユーザーが記録した運動情報を反映させるために必要です。最初は、フォームのデータを取得するコードを用意しておきます。

### **思考の軌跡** ：

「フォームからデータを取得するためには、 **DOMを操作** して、それぞれの入力フィールドから値を取得する必要がある。」

#### **フォームデータを取得するコード** ：

```javascript
// フォームからデータを取得する関数
function getFormData() {
    const type = document.getElementById('type').value;
    const date = document.getElementById('date').value;
    const minutes = parseInt(document.getElementById('minutes').value, 10) || 0;
    const value = parseInt(document.getElementById('value').value, 10) || 0;
    const note = document.getElementById('note').value.trim();

    return {
        id: generateEntryId(),
        date: date,
        type: type,
        minutes: minutes,
        value: value,
        note: note,
        createdAt: Date.now()
    };
}
```

### **思考の軌跡** ：

「フォームからデータを取得する方法が分かった。次は、これらのデータをどう保存するかを考えよう。」

---

## 🌸 7.5 `localStorage` に保存する

次に、 **取得したデータを `localStorage` に保存** する方法を実装します。データを保存する際、すでに保存されているデータがあれば、それを **配列として読み込み** 、新しいデータを **追加** してから再び保存します。

### **思考の軌跡** ：

「フォームから取得したデータを **`localStorage`に保存** するために、すでに保存されているデータを **読み込んで** 、新しいデータを追加し、再度保存する。」

#### **`localStorage` に保存するコード** ：

```javascript
// `localStorage`から保存されたデータを読み込む関数
function loadEntriesFromStorage() {
    const rawData = localStorage.getItem('ichikaWorkoutLogEntries');
    return rawData ? JSON.parse(rawData) : []; // データが無ければ空配列を返す
}

// `localStorage`にデータを保存する関数
function saveDataToLocalStorage(entry) {
    const entries = loadEntriesFromStorage(); // 既存データを読み込み
    entries.push(entry); // 新しいデータを追加
    localStorage.setItem('ichikaWorkoutLogEntries', JSON.stringify(entries)); // 保存
}
```

### **思考の軌跡** ：

「データを`localStorage`に保存する準備が整った。これで、ユーザーが入力した運動記録を **保存できる** 。」

---

## 🌸 7.6 フォーム送信時にデータを保存する

フォームが送信されるとき、入力されたデータを取得し、それを`localStorage`に保存する処理を追加します。フォームの送信を **非同期で処理** するために、 **`submit`イベント** を使います。

### **思考の軌跡** ：

「フォームが送信されたときに、データを **`localStorage`に保存** するようにしたい。 **送信後はフォームをリセット** し、次の入力ができるようにする。」

#### **フォーム送信時の処理** ：

```javascript
document.getElementById('entry-form').addEventListener('submit', function(event) {
    event.preventDefault(); // フォーム送信のデフォルト動作を防ぐ

    const entry = getFormData(); // フォームのデータを取得
    saveDataToLocalStorage(entry); // `localStorage`に保存

    // フォームをリセットして次の入力を準備
    document.getElementById('entry-form').reset();
});
```

### **思考の軌跡** ：

「フォームが送信されると、データが保存されるようになった。これで、ユーザーが入力したデータを **永続的に保存** できるようになった。」

---

## 🌼 7.7 次のステップに進む準備

ここまでで、 **`localStorage`にデータを保存する仕組み** が完成しました。次回は、保存されたデータを **テーブルに表示** し、ユーザーが運動記録を後で確認できるようにします。

### **まとめ** ：

* **`localStorage`を使ってデータを保存する方法** を理解しました。
* フォームから取得したデータを **`localStorage`に保存** し、その後 **表示する準備** をしました。
* 次回は、 **保存されたデータを画面に表示** する処理に進みます。

---

これで **第7章** は終了です！次回は、保存したデータを **テーブルに表示する** 方法に進んでいきます。




もちろんです！ここまでの **JavaScriptコード全体** を提示します。以下は、これまでに解説した内容をすべて組み合わせたコードです。 **新しいコードや不要なコードは追加していません** ので、これまでのステップに沿った内容になります。

```javascript
// 入力フォームからデータを取得する関数
function getFormData() {
    const type = document.getElementById('type').value;
    const date = document.getElementById('date').value;
    const minutes = parseInt(document.getElementById('minutes').value, 10) || 0;
    const value = parseInt(document.getElementById('value').value, 10) || 0;
    const note = document.getElementById('note').value.trim();

    // データをオブジェクトとして返す
    return {
        id: generateEntryId(),
        date: date,
        type: type,
        minutes: minutes,
        value: value,
        note: note,
        createdAt: Date.now()
    };
}

// 一意なIDを生成する関数（ミリ秒単位で一意なID）
function generateEntryId() {
    return String(Date.now());
}

// `localStorage`から運動記録データを取得する関数
function loadEntriesFromStorage() {
    const rawData = localStorage.getItem('ichikaWorkoutLogEntries');
    return rawData ? JSON.parse(rawData) : []; // データが無ければ空配列を返す
}

// `localStorage`に運動記録データを保存する関数
function saveDataToLocalStorage(entry) {
    const entries = loadEntriesFromStorage(); // 既存データを読み込む
    entries.push(entry); // 新しいデータを配列に追加
    localStorage.setItem('ichikaWorkoutLogEntries', JSON.stringify(entries)); // 保存
}

// フォーム送信時にデータを取得し、`localStorage`に保存する処理
document.getElementById('entry-form').addEventListener('submit', function(event) {
    event.preventDefault(); // フォームのデフォルト送信動作を防ぐ

    const entry = getFormData(); // フォームのデータを取得
    saveDataToLocalStorage(entry); // `localStorage`にデータを保存

    // フォームをリセットして、次の入力ができるようにする
    document.getElementById('entry-form').reset();
});
```

---

### **コードの詳細説明** ：

1. **`getFormData`** ：フォームからデータを取得する関数です。フォームの各入力フィールド（運動種目、日付、時間、回数、メモ）から値を取り出し、1つのオブジェクトにまとめて返します。

2. **`generateEntryId`** ：エントリーデータに一意のIDを付与する関数です。`Date.now()`を使って、現在の時間をミリ秒単位で取得し、それをIDとして使います。

3. **`loadEntriesFromStorage`** ：`localStorage`から運動記録のデータを読み込む関数です。もしデータが存在しない場合は空の配列を返します。

4. **`saveDataToLocalStorage`** ：フォームから取得したデータを`localStorage`に保存する関数です。既存のデータを読み込んで新しいデータを追加し、それを再度`localStorage`に保存します。

5. **フォーム送信時の処理** ：フォームが送信されると、フォームのデータを取得し、それを`localStorage`に保存します。その後、フォームをリセットして次のデータを入力できるようにします。

---

### **これまでのステップにおける実装の流れ** ：

* 第7章では、まずデータの保存方法を学び、 **`localStorage`にデータを保存** する方法を実装しました。
* 次に、フォームから入力されたデータを **`localStorage`に保存** し、その後 **データを表示する準備** を進めました。

このコードを使えば、運動記録をフォームで入力し、ブラウザをリロードしてもデータが **`localStorage`に保存** されるため、 **永続的にデータを保持** できます。

次回は、この保存されたデータを **テーブルに表示する** 処理を追加していきます。

---

## 🌼 **やさしい補足：実際の `script.js` では…？**

ここまでのコードは「流れを理解するための最短ルート」です。最終版の `script.js` では、勉強が進んだときに取り入れたい少しだけ大人な書き方が加わっています。

* 保存に使うキー名は `WORKOUT_STORAGE_KEY` という変数にまとめてあります。こうしておくと、後で名前を変えたくなったときに一か所を直すだけで済みます。
* フォームの各要素は、`assignElementReferences()` であらかじめ変数に入れておき、あとから何度も `document.getElementById` を書かなくてよいようにしています。
* 送信後には `entryFormElement.reset()` でフォームをクリアしつつ、`dateInputElement.value` を今日の日付に戻すなど、使う人がうれしい小さな工夫も入っています。

まずはこの章のシンプルなコードで「仕組み」を理解し、慣れてきたら実際のソースと見比べながら、こうした工夫を少しずつ真似していきましょうね。

> 📝 `JSON.stringify` や `JSON.parse` を忘れてしまうと、localStorage に保存したデータがそのまま文字列になってしまいます。「ちゃんと配列に戻っているかな？」と心配になったら、`console.log` で途中経過をのぞいてみると安心です。
