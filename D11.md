### 🔍 第11章：フィルタリング機能（思考の軌跡編）

---

## 🌟 11.1 どんな機能が欲しいか言語化する

データ件数が増えてくると、目的の記録を探すのが大変になってきます。  
そこで「日付を指定してその日の記録だけ表示したい」というニーズが生まれます。

### 初心者の悩み

- 「フォームに入力した日付と、保存済みデータの日付をどう比べればいいの？」
- 「フィルターを解除したいときはどうすればよい？」

### 制作者の思考の軌跡

1. 日付を入力する欄と「解除」ボタンを用意する。
2. ユーザーが日付を選んだら、その値で `loadEntriesFromStorage()` の結果を絞り込む。
3. 絞り込んだ配列で `renderEntryTable()` を描画する。解除したら全件表示。
4. Console で `console.log` を使いながら、どんな配列が表示に渡されているかを目視確認する。

---

## 📅 11.2 フィルター入力欄を追加する

**思考の軌跡**

- 「フォームに合う UI は `<input type="date">` だな」
- 「フィルター解除用のボタンも併せて置いておこう」

#### HTML（抜粋）

```html
<label for="filter-date">日付で絞り込み:</label>
<input type="date" id="filter-date" name="filter-date">
<button id="clear-filter" type="button">フィルタ解除</button>
```

> ここまでで画面上に「日付を選ぶための欄」ができました。次はこの入力値を JavaScript から拾えるようにします。

---

## 🔗 11.3 JavaScript から入力欄を参照する

### **思考の軌跡**

- 「D07/D08 同様、`assignElementReferences()` にフィルター用の DOM も追加しよう」
- 「Console で値を確認して、ちゃんと参照できるかを確かめたい」

```javascript
let filterDateInputElement;
let clearFilterButtonElement;

function assignElementReferences() {
    // 既存のフォーム要素に加えて…
    filterDateInputElement = document.getElementById('filter-date');
    clearFilterButtonElement = document.getElementById('clear-filter');
}
```

> ✅ Consoleチェック
1. `assignElementReferences()` を実行。
2. `filterDateInputElement` と `clearFilterButtonElement` を確認し、正しい要素が入っているかを見る。
3. 日付を選択後、`filterDateInputElement.value` が `YYYY-MM-DD` 形式で返ることを確認。

---

## ⚙️ 11.4 イベントハンドラを結び付ける

**思考の軌跡**

- 「日付が変わったら `renderEntryTable()` を呼べばいい」
- 「解除ボタンをクリックしたときは入力値を空にして全件表示に戻したい」

```javascript
function attachEventListeners() {
    entryFormElement.addEventListener('submit', handleFormSubmit);
    filterDateInputElement.addEventListener('change', renderEntryTable);
    clearFilterButtonElement.addEventListener('click', handleFilterClear);
}

> 📇 補足：`'change'` イベントはいつ発火する？
>
> `input[type="date"]` やセレクトボックスでは、値を選び終わってフォーカスが外れたタイミングなどで `'change'` が発火します。テキスト入力でも Enter を押したり、別の要素をクリックした瞬間に反応します。これに対して `'input'` イベントはタイプするたびに実行され、`'click'` や `'submit'` はボタン操作で発火します。日付ピッカーのように「選び終わったと判断できる瞬間」で処理を走らせたい場面では `'change'` がちょうど良い選択です。リアルタイムで検索したい UI なら `'input'` を使う、チェックボックスなら `'change'` のままでも即座に実行される――といった使い分けを覚えておくと、今後のイベント設計がスムーズになります。

function handleFilterClear() {
    filterDateInputElement.value = '';
    console.log('[handleFilterClear] フィルター解除');
    renderEntryTable();
}
```

> ✅ Consoleチェック
日付を変更 → `renderEntryTable` が呼ばれているか、`handleFilterClear()` でログが出るかを確認。

---

## 🔁 11.5 `renderEntryTable()` で絞り込む

**思考の軌跡**

- 「既存の `renderEntryTable` にフィルター処理を挟むだけで済みそうだ」
- 「配列を絞った結果を `console.log` して、何件に減ったかを目視したい」

```javascript
function renderEntryTable() {
    const entries = loadEntriesFromStorage();
    const selectedDate = filterDateInputElement.value;

    let filteredEntries = entries;
    if (selectedDate) {
        filteredEntries = entries.filter((entry) => entry.date === selectedDate);
    }
    console.log('[renderEntryTable] filteredEntries:', filteredEntries);

    filteredEntries.sort((a, b) => b.createdAt - a.createdAt);
    totalCountElement.textContent = String(filteredEntries.length);

    let tableHtml = '';
    for (const entry of filteredEntries) {
        tableHtml += `
            <tr>
                <td>${entry.date}</td>
                <td>${entry.type}</td>
                <td class="text-end">${entry.minutes || ''}</td>
                <td class="text-end">${entry.value || ''}</td>
                <td>${entry.note || ''}</td>
            </tr>
        `;
    }

    if (filteredEntries.length === 0) {
        tableHtml = '<tr><td colspan="5">データがありません</td></tr>';
    }

    entryListElement.innerHTML = tableHtml;
}
```

> ✅ Consoleチェック
フィルターを変更 → `[renderEntryTable] filteredEntries:` の配列が選択した日付だけに減っているか確認。

---

## 🧪 11.6 動作確認の手順

1. いくつか日付違いのレコードを登録する。
2. 日付フィルターを変更し、該当データだけが表示されるか確かめる。
3. 「フィルタ解除」ボタンを押し、全データが戻ってくるか確認。
4. Console で `filteredEntries` や `filterDateInputElement.value` を追いながら挙動を把握する。

---

## # **全体のJavaScriptコード**

```javascript
const WORKOUT_STORAGE_KEY = 'ichikaWorkoutLogEntries';

let entryFormElement;
let dateInputElement;
let typeInputElement;
let minutesInputElement;
let valueInputElement;
let noteInputElement;
let entryListElement;
let totalCountElement;
let filterDateInputElement;
let clearFilterButtonElement;

function assignElementReferences() {
    entryFormElement = document.getElementById('entry-form');
    dateInputElement = document.getElementById('date');
    typeInputElement = document.getElementById('type');
    minutesInputElement = document.getElementById('minutes');
    valueInputElement = document.getElementById('value');
    noteInputElement = document.getElementById('note');
    entryListElement = document.getElementById('list');
    totalCountElement = document.getElementById('total-count');
    filterDateInputElement = document.getElementById('filter-date');
    clearFilterButtonElement = document.getElementById('clear-filter');
}

function attachEventListeners() {
    entryFormElement.addEventListener('submit', handleFormSubmit);
    filterDateInputElement.addEventListener('change', renderEntryTable);
    clearFilterButtonElement.addEventListener('click', handleFilterClear);
}

function generateEntryId() {
    return Date.now();
}

function getFormData() {
    const timestamp = generateEntryId();

    return {
        id: String(timestamp),
        date: dateInputElement.value,
        type: typeInputElement.value,
        minutes: parseInt(minutesInputElement.value, 10) || 0,
        value: parseInt(valueInputElement.value, 10) || 0,
        note: noteInputElement.value.trim(),
        createdAt: timestamp
    };
}

function loadEntriesFromStorage() {
    const rawData = localStorage.getItem(WORKOUT_STORAGE_KEY);
    return rawData ? JSON.parse(rawData) : [];
}

function saveEntriesToStorage(entries) {
    localStorage.setItem(WORKOUT_STORAGE_KEY, JSON.stringify(entries));
}

function handleFormSubmit(event) {
    event.preventDefault();

    const entry = getFormData();
    const entries = loadEntriesFromStorage();
    entries.push(entry);
    saveEntriesToStorage(entries);

    entryFormElement.reset();
    renderEntryTable();
}

function handleFilterClear() {
    filterDateInputElement.value = '';
    console.log('[handleFilterClear] フィルター解除');
    renderEntryTable();
}

function renderEntryTable() {
    const entries = loadEntriesFromStorage();
    const selectedDate = filterDateInputElement.value;

    let filteredEntries = entries;
    if (selectedDate) {
        filteredEntries = entries.filter((entry) => entry.date === selectedDate);
    }
    console.log('[renderEntryTable] filteredEntries:', filteredEntries);

    filteredEntries.sort((a, b) => b.createdAt - a.createdAt);
    totalCountElement.textContent = String(filteredEntries.length);

    let tableHtml = '';
    for (const entry of filteredEntries) {
        tableHtml += `
            <tr>
                <td>${entry.date}</td>
                <td>${entry.type}</td>
                <td class="text-end">${entry.minutes || ''}</td>
                <td class="text-end">${entry.value || ''}</td>
                <td>${entry.note || ''}</td>
            </tr>
        `;
    }

    if (filteredEntries.length === 0) {
        tableHtml = '<tr><td colspan="5">データがありません</td></tr>';
    }

    entryListElement.innerHTML = tableHtml;
}

function initializePage() {
    assignElementReferences();
    attachEventListeners();
    renderEntryTable();
}

document.addEventListener('DOMContentLoaded', initializePage);
```

---

## ✅ 11.7 まとめ

- 日付で絞りたいというニーズを言葉にし、入力欄と解除ボタンを用意した。
- 参照取得 → イベント登録 → `renderEntryTable` の改造という順で段階を踏み、フィルタ処理を実装した。
- それぞれのステップで `console.log` を仕込んだり Console から手動で確認したりすることで、挙動を目視しながら進められるようにした。

テーブル表示の基礎が整ったところで、次の章では UI を整えるなど仕上げに入ります。焦らず少しずつ「何をしたいのか」を考えながら進めていきましょう。
