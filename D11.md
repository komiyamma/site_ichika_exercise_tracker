# 🔍 Day 11：見たい記録だけ探せる！フィルタリング機能（心の声と一緒に編）

---

## 🌟 11.1 どんな機能が欲しいか、言葉にしてみよう

運動の記録がたくさん増えてくると、「あの日の記録、どこだっけ？」って、目的の記録を探すのがだんだん大変になってきます。
そこで、「日付を指定して、その日の記録だけをパッと表示したい！」という、便利な機能が欲しくなってきます。

### 初心者さんの、心の声

-   「フォームで選んだ日付と、保存されているデータの日付を、どうやって比べたらいいんだろう？」
-   「一度絞り込んだ表示を、また元に戻したい（フィルターを解除したい）ときは、どうすればいいのかな？」

### アプリ制作者の、心の旅

1.  まずは、日付を入力するための欄と、「フィルタを解除する」ボタンをHTMLに用意しよう。
2.  ユーザーが日付を選んだら、その日付の値をヒントにして、`loadEntriesFromStorage()`で取得した全データの中から、日付が一致するものだけを絞り込もう。
3.  絞り込んだ結果の配列を使って、`renderEntryTable()`でテーブルを描画するように、ちょっとだけ改造しよう。解除ボタンが押されたら、また全件表示に戻してあげよう。
4.  ちゃんと絞り込めているか、`console.log`を使いながら、テーブルに表示する直前の配列の中身を目で見て確認しよう。

---

## 📅 11.2 フィルター用の入力欄を、HTMLに追加しよう

### 心の旅（UIの選択）

-   「日付を入力するんだから、UIは`<input type="date">`が一番ぴったりだな。」
-   「フィルターを元に戻すための、解除ボタンも隣に置いておこう。」

### HTML（抜粋）

```html
<label for="filter-date">日付で絞り込み:</label>
<input type="date" id="filter-date" name="filter-date">
<button id="clear-filter" type="button">フィルタ解除</button>
```

> ここまでで、画面上に「日付を選ぶための欄」ができましたね。次は、この入力欄をJavaScriptから操作できるようにします。

---

## 🔗 11.3 JavaScriptから、入力欄を参照できるようにしよう

### 心の旅（参照の取得）

-   「Day 7やDay 8と同じように、`assignElementReferences()`関数に、フィルター用のHTML要素も追加しよう。」
-   「ちゃんと参照できているか、コンソールで値を確認して、安心したいな。」

```javascript
// フィルター用の入力欄と、解除ボタンの変数を追加
let filterDateInputElement;
let clearFilterButtonElement;

function assignElementReferences() {
    // ...（今までの要素の参照に加えて）...
    filterDateInputElement = document.getElementById('filter-date');
    clearFilterButtonElement = document.getElementById('clear-filter');
}
```

> ✅ **コンソールでチェック！**
> 
> 1.  `assignElementReferences()`を実行します。
> 2.  コンソールで`filterDateInputElement`や`clearFilterButtonElement`と打ち込んで、正しいHTML要素が入っているか見てみましょう。
> 3.  日付ピッカーで日付を選択した後、`filterDateInputElement.value`で、`YYYY-MM-DD`という形式の文字列が取得できることを確認しましょう。

---

## ⚙️ 11.4 イベントハンドラを、結びつけよう

### 心の旅（イベントの連携）

-   「日付の入力欄の値が変わったら（`change`イベント）、`renderEntryTable()`を呼び出して、テーブルを再描画すれば良さそうだな。」
-   「解除ボタンがクリックされたときは、日付の入力欄を空っぽにして、もう一度`renderEntryTable()`を呼べば、全件表示に戻るはずだ。」

```javascript
function attachEventListeners() {
    // ...（今までのイベントリスナーに加えて）...
    entryFormElement.addEventListener('submit', handleFormSubmit);
    // 日付フィルターの値が変わったら、renderEntryTableを呼び出す
    filterDateInputElement.addEventListener('change', renderEntryTable);
    // フィルター解除ボタンがクリックされたら、handleFilterClearを呼び出す
    clearFilterButtonElement.addEventListener('click', handleFilterClear);
}
```

> 📇 **補足：`'change'`イベントって、いつ動くの？**
> 
> `<input type="date">`や、セレクトボックスのような入力欄では、ユーザーが値を選び終わって、入力欄からフォーカスが外れたタイミングなどで`'change'`イベントが発生します。
> これに対して、`'input'`イベントは、文字をタイプするたびに発生します。
> 日付ピッカーのように「選び終わった」というタイミングで処理をしたい場面では、`'change'`イベントがちょうど良い選択なんです。

```javascript
// フィルター解除ボタンが押されたときの処理
function handleFilterClear() {
    // 日付入力欄を空っぽにする
    filterDateInputElement.value = '';
    console.log('[handleFilterClear] フィルターが解除されました！');
    // テーブルを再描画（フィルターが空なので、全件表示になる）
    renderEntryTable();
}
```

> ✅ **コンソールでチェック！**
> 
> 日付を変更したときに、`renderEntryTable`が呼ばれているか、そして`handleFilterClear()`を実行したときに、コンソールにログが表示されるかを確認してみましょう。

---

## 🔁 11.5 `renderEntryTable()`関数を、絞り込みができるように改造しよう

### 心の旅（配列の絞り込み）

-   「今ある`renderEntryTable`関数に、フィルター処理をちょっと挟むだけで、実現できそうだぞ。」
-   「配列を絞り込んだ結果を、`console.log`で出力して、何件に減ったのかを、自分の目で確かめたいな。」

```javascript
function renderEntryTable() {
    // 1. localStorageから全データを読み込む
    const entries = loadEntriesFromStorage();
    // 2. 日付フィルターで、今どの目が選ばれているかを取得
    const selectedDate = filterDateInputElement.value;

    // 3. 表示する用の、新しい配列を準備（最初は全データを入れておく）
    let filteredEntries = entries;
    // 4. もし、日付が選択されていたら、絞り込み処理を実行！
    if (selectedDate) {
        // entries配列の中から、日付がselectedDateと一致するものだけを残す
        filteredEntries = entries.filter((entry) => entry.date === selectedDate);
    }
    console.log('[renderEntryTable] これから表示するデータ:', filteredEntries);

    // 5. 絞り込んだ後の配列を、新しい順に並び替える
    filteredEntries.sort((a, b) => b.createdAt - a.createdAt);
    // 6. 絞り込んだ後の件数を、画面に表示する
    totalCountElement.textContent = String(filteredEntries.length);

    // 7. 絞り込んだ後の配列を使って、テーブルのHTMLを組み立てる
    let tableHtml = '';
    for (const entry of filteredEntries) {
        tableHtml += `
            <tr>
                <td>${entry.date}</td>
                <td>${entry.type}</td>
                <td class="text-end">${entry.minutes || ''}</td>
                <td class="text-end">${entry.value || ''}</td>
                <td>${entry.note || ''}</td>
            </tr>
        `;
    }

    // 8. もし絞り込んだ結果が0件だったら、「データがありません」と表示
    if (filteredEntries.length === 0) {
        tableHtml = '<tr><td colspan="5">表示するデータがありません。</td></tr>';
    }

    // 9. 出来上がったHTMLを、テーブルに流し込む
    entryListElement.innerHTML = tableHtml;
}
```

> ✅ **コンソールでチェック！**
> 
> 日付フィルターの値を変更したときに、コンソールに表示される`[renderEntryTable] これから表示するデータ:`の配列の中身が、ちゃんと選択した日付だけのデータに減っているか、確認してみましょう。

---

## 🧪 11.6 ちゃんと動くか、テストしてみよう！

1.  まずは、いくつか違う日付で、記録を登録してみましょう。
2.  日付フィルターで、特定の日付を選んでみて、その日のデータだけが表示されるか確かめてみましょう。
3.  「フィルタ解除」ボタンを押して、また全てのデータが表示される状態に戻るか、確認してみましょう。
4.  コンソールで`filteredEntries`の中身や、`filterDateInputElement.value`の値を追いかけながら、自分の思った通りにプログラムが動いているか、把握してみましょう。

---

## 全体のJavaScriptコード（Day 11時点）

```javascript
const WORKOUT_STORAGE_KEY = 'ichikaWorkoutLogEntries';

let entryFormElement;
let dateInputElement;
// ...（他の要素の変数宣言）...
let filterDateInputElement;
let clearFilterButtonElement;

function assignElementReferences() {
    // ...（他の要素の参照取得）...
    filterDateInputElement = document.getElementById('filter-date');
    clearFilterButtonElement = document.getElementById('clear-filter');
}

function attachEventListeners() {
    entryFormElement.addEventListener('submit', handleFormSubmit);
    filterDateInputElement.addEventListener('change', renderEntryTable);
    clearFilterButtonElement.addEventListener('click', handleFilterClear);
}

// ... (getFormData, loadEntriesFromStorage, saveEntriesToStorage などは変更なし) ...

function handleFormSubmit(event) {
    // ... (変更なし) ...
}

function handleFilterClear() {
    filterDateInputElement.value = '';
    renderEntryTable();
}

function renderEntryTable() {
    const entries = loadEntriesFromStorage();
    const selectedDate = filterDateInputElement.value;

    let filteredEntries = entries;
    if (selectedDate) {
        filteredEntries = entries.filter((entry) => entry.date === selectedDate);
    }

    filteredEntries.sort((a, b) => b.createdAt - a.createdAt);
    totalCountElement.textContent = String(filteredEntries.length);

    let tableHtml = '';
    for (const entry of filteredEntries) {
        // ... (テーブルのHTML組み立て) ...
    }

    if (filteredEntries.length === 0) {
        tableHtml = '<tr><td colspan="5">表示するデータがありません。</td></tr>';
    }

    entryListElement.innerHTML = tableHtml;
}

function initializePage() {
    assignElementReferences();
    attachEventListeners();
    renderEntryTable();
}

document.addEventListener('DOMContentLoaded', initializePage);
```

---

## ✅ 11.7 まとめ

-   「日付で記録を絞り込みたい」という、ユーザーの気持ちを言葉にして、そのための入力欄と解除ボタンを用意した。
-   「HTML要素の参照を取得 → イベントを登録 → `renderEntryTable`関数を改造」という順番で、段階的にフィルター機能を実装した。
-   それぞれのステップで`console.log`を仕込んだり、コンソールから手動で値を確認したりすることで、プログラムの挙動を目で追いながら、安心して進められるようにした。

テーブルの表示の基本が整ったところで、次の章では、Bootstrapを使ってUIをもっときれいに整えるなど、アプリの仕上げに入っていきます。焦らず、一つずつ「何をしたいのか」を考えながら、進めていきましょうね。

---

<h1><a href="D12.md">Day12 へ</a></h1>